
> discogs-mcp@0.0.0 test
> vitest


 DEV  v3.0.9 /Users/rian/Documents/GitHub/discogs-mcp

[vpw:info] Starting isolated runtimes for vitest.config.mts...
stdout | test/utils/retry.test.ts > Retry Utility > withRetry > should retry on failure and eventually succeed
Retry attempt 1/3 after 105.02646314354097ms delay

stdout | test/utils/retry.test.ts > Retry Utility > withRetry > should retry on failure and eventually succeed
Retry attempt 2/3 after 203.05680601226965ms delay

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should successfully get a request token
Getting OAuth header for request token...

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should successfully get a request token
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Foauth%2Frequest_token&oauth_callback%3Dhttp%253A%252F%252Flocalhost%253A3000%252Fcallback%26oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3DWjoFv8494ljuE2EiFbBRSYkUT66KFhvr%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811039%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&
OAuth signature: VnZFy2fHcc9W/7aINjfSUbDVGz8=

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should successfully get a request token
Authorization header: OAuth oauth_consumer_key="test-consumer-key", oauth_nonce="WjoFv8494ljuE2EiFbBRSYkUT66KFhvr", oauth_signature_method="HMAC-SHA1", oauth_timestamp="1765811039", oauth_version="1.0", oauth_callback="http%3A%2F%2Flocalhost%3A3000%2Fcallback", oauth_signature="VnZFy2fHcc9W%2F7aINjfSUbDVGz8%3D"
Making request to: https://api.discogs.com/oauth/request_token

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should successfully get a request token
Discogs response: oauth_token=test-token&oauth_token_secret=test-secret&oauth_callback_confirmed=true

stdout | test/utils/retry.test.ts > Retry Utility > withRetry > should fail after max retries
Retry attempt 1/2 after 108.27871612848023ms delay

stdout | test/utils/retry.test.ts > Retry Utility > withRetry > should fail after max retries
Retry attempt 2/2 after 203.01652119243764ms delay

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle API errors
Getting OAuth header for request token...

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle API errors
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Foauth%2Frequest_token&oauth_callback%3Dhttp%253A%252F%252Flocalhost%253A3000%252Fcallback%26oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3Dh9oJlSWhObOS17DjcTnR1CgHIdSg10xZ%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811039%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&
OAuth signature: LYKdywZehuWw0VDJIngECy79y9s=

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle API errors
Authorization header: OAuth oauth_consumer_key="test-consumer-key", oauth_nonce="h9oJlSWhObOS17DjcTnR1CgHIdSg10xZ", oauth_signature_method="HMAC-SHA1", oauth_timestamp="1765811039", oauth_version="1.0", oauth_callback="http%3A%2F%2Flocalhost%3A3000%2Fcallback", oauth_signature="LYKdywZehuWw0VDJIngECy79y9s%3D"
Making request to: https://api.discogs.com/oauth/request_token

stderr | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle API errors
Discogs API error: ResponseError: HTTP 401: Unauthorized
    at withRetry (/Users/rian/Documents/GitHub/discogs-mcp/src/utils/retry.ts:178:11)
    at withRetry (/Users/rian/Documents/GitHub/discogs-mcp/src/utils/retry.ts:108:17)
    at fetchWithRetry (/Users/rian/Documents/GitHub/discogs-mcp/src/utils/retry.ts:171:17)
    at DiscogsAuth.getRequestToken (/Users/rian/Documents/GitHub/discogs-mcp/src/auth/discogs.ts:179:21)
    at /Users/rian/Documents/GitHub/discogs-mcp/test/auth/discogs.spec.ts:61:4
    at Users/rian/Documents/GitHub/discogs-mcp/node_modules/@vitest/runner/dist/index.js:573:22 {
  response: {
    ok: false,
    status: 401,
    statusText: 'Unauthorized',
    text: [Function: text]
  }
}

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle malformed responses
Getting OAuth header for request token...

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle malformed responses
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Foauth%2Frequest_token&oauth_callback%3Dhttp%253A%252F%252Flocalhost%253A3000%252Fcallback%26oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3DWU3eDPyv1rrlVNInVhcqo1xMKuL2iKVt%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811039%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&
OAuth signature: hst66IVl0Rqm4kx4VIxgT18VeRE=

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle malformed responses
Authorization header: OAuth oauth_consumer_key="test-consumer-key", oauth_nonce="WU3eDPyv1rrlVNInVhcqo1xMKuL2iKVt", oauth_signature_method="HMAC-SHA1", oauth_timestamp="1765811039", oauth_version="1.0", oauth_callback="http%3A%2F%2Flocalhost%3A3000%2Fcallback", oauth_signature="hst66IVl0Rqm4kx4VIxgT18VeRE%3D"
Making request to: https://api.discogs.com/oauth/request_token

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle malformed responses
Discogs response: invalid_response

stderr | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle malformed responses
Discogs API error: Error: Invalid response from Discogs: missing oauth_token or oauth_token_secret
    at DiscogsAuth.getRequestToken (/Users/rian/Documents/GitHub/discogs-mcp/src/auth/discogs.ts:201:11)
    at /Users/rian/Documents/GitHub/discogs-mcp/test/auth/discogs.spec.ts:74:4
    at Users/rian/Documents/GitHub/discogs-mcp/node_modules/@vitest/runner/dist/index.js:573:22

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should return all items when no query is provided
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fper_page%3D50&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DXxOyiuaVng1PU3FcKPy5ue8PpWCKV2AJ%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811039%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: QU2w9FpEWiX6cDeWRL5pTuxVfGg=

stdout | test/utils/retry.test.ts > Retry Utility > fetchWithRetry > should retry on 429 status
Retry attempt 1/3 after 2073.3380018376392ms delay

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should filter by artist name when query is provided
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DMORTwpGkAFryjW2U6oOotuCVGZkxLnc6%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811039%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: j2WU3y9uwpi53UClurOIIKwcNag=

stdout | test/utils/retry.test.ts > Retry Utility > fetchWithRetry > should parse Retry-After header in seconds
Retry attempt 1/3 after 5213.634276397521ms delay

stdout | test/utils/retry.test.ts > Retry Utility > fetchWithRetry > should parse Retry-After header as HTTP date
Retry attempt 1/3 after 2704.149075414377ms delay

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getAccessToken > should successfully exchange for access token
OAuth signature base string: POST&https%3A%2F%2Fapi.discogs.com%2Foauth%2Faccess_token&oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3DGVPXldRgUa0AkhV1T48Mwuc3BZHyNGbZ%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811039%26oauth_token%3Drequest-token%26oauth_verifier%3Dverifier%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&request-secret
OAuth signature: RWEYr1zBres0ynyag53ZiQGbvxk=

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getAccessToken > should handle access token errors
OAuth signature base string: POST&https%3A%2F%2Fapi.discogs.com%2Foauth%2Faccess_token&oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3DTAvZpczpEOQ8HmKV6bPPmK3owdf7ADgT%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811039%26oauth_token%3Drequest-token%26oauth_verifier%3Dinvalid-verifier%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&request-secret
OAuth signature: pRf6Q24Itj6cxbYZf31Y0Bu24k4=

stderr | test/auth/discogs.spec.ts > DiscogsAuth > getAccessToken > should handle access token errors
Discogs API error: ResponseError: HTTP 401: Unauthorized
    at withRetry (/Users/rian/Documents/GitHub/discogs-mcp/src/utils/retry.ts:178:11)
    at withRetry (/Users/rian/Documents/GitHub/discogs-mcp/src/utils/retry.ts:108:17)
    at fetchWithRetry (/Users/rian/Documents/GitHub/discogs-mcp/src/utils/retry.ts:171:17)
    at DiscogsAuth.getAccessToken (/Users/rian/Documents/GitHub/discogs-mcp/src/auth/discogs.ts:244:21)
    at /Users/rian/Documents/GitHub/discogs-mcp/test/auth/discogs.spec.ts:127:4
    at Users/rian/Documents/GitHub/discogs-mcp/node_modules/@vitest/runner/dist/index.js:573:22 {
  response: {
    ok: false,
    status: 401,
    statusText: 'Unauthorized',
    text: [Function: text]
  }
}

 âœ“ test/utils/kvLogger.test.ts (6 tests) 237ms
stdout | test/utils/retry.test.ts > Retry Utility > fetchWithRetry > should retry on 5xx errors
Retry attempt 1/3 after 109.7463802231104ms delay

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getAccessToken > should handle malformed access token responses
OAuth signature base string: POST&https%3A%2F%2Fapi.discogs.com%2Foauth%2Faccess_token&oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3DiguSy9WEgmONaTHpDGStBu393wmKDZTT%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811039%26oauth_token%3Drequest-token%26oauth_verifier%3Dverifier%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&request-secret
OAuth signature: Z5AzSqnOsfNmbHJLRIuo51e2IoY=

stderr | test/auth/discogs.spec.ts > DiscogsAuth > getAccessToken > should handle malformed access token responses
Discogs API error: Error: Invalid response from Discogs: missing oauth_token or oauth_token_secret
    at DiscogsAuth.getAccessToken (/Users/rian/Documents/GitHub/discogs-mcp/src/auth/discogs.ts:265:11)
    at /Users/rian/Documents/GitHub/discogs-mcp/test/auth/discogs.spec.ts:140:4
    at Users/rian/Documents/GitHub/discogs-mcp/node_modules/@vitest/runner/dist/index.js:573:22

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getAuthHeaders > should generate correct auth headers for API requests
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftest&oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3DuzolXvxoDNWpviNtuA8w4O3El7Edua0y%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811039%26oauth_token%3Daccess-token%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&access-secret
OAuth signature: 1kZWjXs+1GxNR+ubNVRRvgXPa+w=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should filter by album title when query is provided
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DgEUktR4BQcUNU0cCOMgHjhEKfnp3Irgy%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811039%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: kpRhi8FNmR0cGSZJWgMuPaOxKcY=

 âœ“ test/utils/retry.test.ts (9 tests) 308ms
 âœ“ test/utils/moodMapping.test.ts (10 tests) 311ms
stdout | test/auth/discogs.spec.ts > DiscogsAuth > OAuth signature generation > should generate consistent signatures for the same parameters
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Ftest&oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3Dffffffffffffffffffffffffffffffff%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1672531200%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&test-secret
OAuth signature: g06ttDnmU3albDFhbKWiPttm5uk=

stdout | test/auth/discogs.spec.ts > DiscogsAuth > OAuth signature generation > should generate consistent signatures for the same parameters
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Ftest&oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3Dffffffffffffffffffffffffffffffff%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1672531200%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&test-secret
OAuth signature: g06ttDnmU3albDFhbKWiPttm5uk=

 âœ“ test/auth/discogs.spec.ts (9 tests) 337ms
 âœ“ test/utils/rateLimit.test.ts (15 tests) 424ms
stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should filter by genre when query is provided
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3D3KrDTDqBDVGEeuLziSWgjLjzajr9EZXp%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811039%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: wXw740dLAnKIb1OIchhGTcxMSH8=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should return empty results when no matches found
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3D5fO2HS3BaOIyNTp8iE8g694WH9Nh5QH7%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811039%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: mCN5VO66eNwNodWxGUFVkvahQ5o=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should handle case-insensitive search
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DHeKt27odykAnmZBDzO4tG2mHVGUnbpJH%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811039%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: r+X92ZFEYjTUVTtp0jvvTguFXZI=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should find releases with multi-word queries like "Miles Davis Kind of Blue"
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3D2Y7mlj16tPWqOTjdeRBwT5YEIdrkZ3Jc%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811040%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: 7zltXOCbPAd9H8W8hocV5wRgjJI=

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log successful MCP requests
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
Response status: 200 Text length: 270 Text: event: message
data: {"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{"listChanged":true},"resources":{"listChanged":true},"completions":{},"prompts":{"listChanged":true}},"serverInf

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/index.spec.ts > Discogs MCP Server > should handle initialize request
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log parse errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should handle decade queries like "1960s" matching years in that decade
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DKXbOZZOtI9nNfs4ZRxIYNUHA62r9K2U9%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811040%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: Y3JrG3s+LyVxLYl55RunwVw/Ov4=

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
Response status: 200 Text length: 270 Text: event: message
data: {"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{"listChanged":true},"resources":{"listChanged":true},"completions":{},"prompts":{"listChanged":true}},"serverInf

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/index.spec.ts > Discogs MCP Server > should handle parse errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
Session ID extraction: { providedSessionId: 'mcp-efa543eedde602b1b37f96fe50283eb1' }
Looking up KV key: session:mcp-efa543eedde602b1b37f96fe50283eb1

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
No session found for key: session:mcp-efa543eedde602b1b37f96fe50283eb1

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
Response status: 200 Text length: 137 Text: event: message
data: {"jsonrpc":"2.0","id":2,"error":{"code":-32603,"message":"Authentication required to access collection resource"}}



stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should skip rate limiting for initialize method
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/index.spec.ts > Discogs MCP Server > should handle empty body
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 270 Text: event: message
data: {"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{"listChanged":true},"resources":{"listChanged":true},"completions":{},"prompts":{"listChanged":true}},"serverInf

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 224 Text: event: message
data: {"result":{"resources":[{"uri":"discogs://collection","name":"collection","mimeType":"application/json","description":"Complete Discogs collection for the authenticated user"}]},"

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Session ID extraction: { providedSessionId: 'mcp-efa543eedde602b1b37f96fe50283eb1' }

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Fetching fresh data for userProfiles:test-access-token
Making OAuth request to /oauth/identity with token: test-acces...

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Foauth%2Fidentity&oauth_consumer_key%3Dtest-key%26oauth_nonce%3D3JPBQcCjHxgdhTTJQfsQMmr0F0XUA96r%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811040%26oauth_token%3Dtest-access-token%26oauth_version%3D1.0
OAuth signing key: test-secret&test-access-secret
OAuth signature: jjEfTzy6S4DdPNyqlZgcQyXEWM8=

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Fetching fresh data for collections:testuser:all:default:desc

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fper_page%3D100&oauth_consumer_key%3Dtest-key%26oauth_nonce%3D5taoaA3SPfU5Fj4yYVOvf7FtWPG9KD7N%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811040%26oauth_token%3Dtest-access-token%26oauth_version%3D1.0
OAuth signing key: test-secret&test-access-secret
OAuth signature: GcBBo7KjhjadSE7/U9PELeSXjCM=

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle empty request body
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should measure request latency accurately
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

 â¯ test/index.spec.ts (6 tests | 3 failed) 99ms
   Ã— Discogs MCP Server > should handle initialize request 21ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return server info for GET requests to main endpoint
   Ã— Discogs MCP Server > should handle parse errors 9ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Discogs MCP Server > should handle empty body 5ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return 404 for unknown paths
   âœ“ Discogs MCP Server > should return 404 for unknown paths
 â¯ test/integration/logging-ratelimit.test.ts (7 tests | 7 failed) 109ms
   Ã— Logging and Rate Limiting Integration > should log successful MCP requests 19ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should log parse errors 4ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors 3ms
     â†’ expected 406 to be 429 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should skip rate limiting for initialize method 20ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully 4ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle empty request body 5ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should measure request latency accurately 6ms
     â†’ undefined is not iterable (cannot read property Symbol(Symbol.iterator))
stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should handle multiple decades with OR logic (1960s OR 1970s)
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DeuPBniCWYJPuEdqfOSadFD0y96FEuCuK%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811040%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: O9nok7OBb1m34KBE+WiSBbJxnDM=

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 2115 Text: event: message
data: {"result":{"contents":[{"uri":"discogs://collection","mimeType":"application/json","text":"{\n  \"releases\": [\n    {\n      \"id\": 123456,\n      \"instance_id\": 123456,\n    

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 3681 Text: event: message
data: {"result":{"tools":[{"name":"ping","description":"Test connectivity to the Discogs MCP server","inputSchema":{"$schema":"http://json-schema.org/draft-07/schema#","type":"object","

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Session ID extraction: { providedSessionId: 'mcp-efa543eedde602b1b37f96fe50283eb1' }

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Fetching fresh data for userProfiles:test-access-token
Making OAuth request to /oauth/identity with token: test-acces...

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Foauth%2Fidentity&oauth_consumer_key%3Dtest-key%26oauth_nonce%3D551uGMzXv8Lwlu3mNLzY8uwvStNDhYmN%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811040%26oauth_token%3Dtest-access-token%26oauth_version%3D1.0
OAuth signing key: test-secret&test-access-secret
OAuth signature: q9K6Di5wNGdHpLcQQ5lEXhoSnWU=

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Fetching fresh data for searches:testuser:Beatles:1

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DKNkYNDplcv9DBTlyZvRKI4k94UpgqhWM%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811040%26oauth_token%3Dtest-access-token%26oauth_version%3D1.0
OAuth signing key: test-secret&test-access-secret
OAuth signature: o9ooClZNdRCO8/R8ecaVKUt1cKk=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should handle complex style and decade queries like "post-bop 1960s 1970s vinyl"
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DNQsSaeobccHhwHfcibqFOTOUqQ7qOlnu%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811040%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: +qReK3Rz2CwCMCu16yzHOznwATE=

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 372 Text: event: message
data: {"result":{"content":[{"type":"text","text":"Found 1 results for \"Beatles\" in your collection (showing 1 items):\nâ€¢ [ID: 123456] The Beatles - Abbey Road (1969)\n  Format: Vinyl

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 421 Text: event: message
data: {"result":{"prompts":[{"name":"browse_collection","description":"Browse and explore your Discogs music collection","arguments":[]},{"name":"find_music","description":"Find specifi

 âœ“ test/integration/mcp-client.test.ts (3 tests) 394ms
   âœ“ MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features 315ms
stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should find release by specific ID 654321
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DfBMF833QhsLMtR0eMe7lkO4ULXQIgAmI%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811040%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: OodpdAi0kHdFV2+kx14ShGgm7hM=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should handle temporal queries like "rock vinyl recent"
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DAZyhlz8fXJTawYxmcJ5zC5uZ9MvVyGcb%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811040%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: Ksf1pcZP6rvaVMmy9LJeeySzoT0=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should use OR logic for multi-word genre searches like "ambient drone progressive"
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DGoxdozgck0qTTYTTJZaPo4wlifGzczDz%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811040%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: r3JzApstEVTGhRV1Tnpgi3qCsO4=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should prioritize releases with more matching terms using relevance scoring
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DZ1TgTgmqWQnI6fPUhPYWGw0nbNYuRzcx%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811041%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: h1XGxeCIDSRZjbhds4NmIUwdpWw=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should prioritize mood-relevant releases for contextual queries like "cooking dinner mellow upbeat background"
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DMBImOdo9bFB98rL8pPZmM4jDtYoUGqTr%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811041%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: 33Kj4Ss2tvDvFYcK0+G8DWm16yA=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should not trigger mood detection for specific album searches like "Dark Side of the Moon"
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DCgenPfwjbo8oWwJKto00beGZMJHHVg70%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811041%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: mSiq6IuaC0KfqB/ALLAyBejeGWs=

 âœ“ test/clients/discogs.test.ts (16 tests) 2286ms

â¯â¯â¯â¯â¯â¯ Failed Tests 10 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle initialize request
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:34:27
     32|   await waitOnExecutionContext(ctx)
     33| 
     34|   expect(response.status).toBe(200)
       |                           ^
     35|   expect(response.headers.get('content-type')).toBe('application/json')
     36| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/10]â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle parse errors
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:89:27
     87|   await waitOnExecutionContext(ctx)
     88| 
     89|   expect(response.status).toBe(200) // JSON-RPC errors still return 200
       |                           ^
     90|   const result = await response.json()
     91|   expect(result).toMatchObject({

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/10]â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle empty body
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:115:27
    113|   await waitOnExecutionContext(ctx)
    114| 
    115|   expect(response.status).toBe(200)
       |                           ^
    116|   const result = await response.json()
    117|   expect(result).toMatchObject({

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/10]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log successful MCP requests
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:60:27
     58|   const response = await worker.fetch(request, mockEnv, {} as any)
     59| 
     60|   expect(response.status).toBe(200)
       |                           ^
     61| 
     62|   // Verify logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/10]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log parse errors
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:89:27
     87|   const response = await worker.fetch(request, mockEnv, {} as any)
     88| 
     89|   expect(response.status).toBe(200)
       |                           ^
     90| 
     91|   // Verify error logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/10]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors
AssertionError: expected 406 to be 429 // Object.is equality

- Expected
+ Received

- 429
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:125:27
    123|   const response = await worker.fetch(request, mockEnv, {} as any)
    124| 
    125|   expect(response.status).toBe(429)
       |                           ^
    126|   expect(response.headers.get('Retry-After')).toBeDefined()
    127| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/10]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should skip rate limiting for initialize method
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:167:27
    165| 
    166|   // Should succeed despite rate limit
    167|   expect(response.status).toBe(200)
       |                           ^
    168| 
    169|   // Rate limiting should not have been checked for initialize

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/10]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:207:27
    205| 
    206|   // Should still work without KV namespaces
    207|   expect(response.status).toBe(200)
       |                           ^
    208| 
    209|   // No KV operations should have been attempted

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[8/10]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle empty request body
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:223:27
    221|   const response = await worker.fetch(request, mockEnv, {} as any)
    222| 
    223|   expect(response.status).toBe(200)
       |                           ^
    224| 
    225|   // Verify error logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[9/10]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should measure request latency accurately
TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
 â¯ test/integration/logging-ratelimit.test.ts:262:24
    260|   const endTime = Date.now()
    261| 
    262|   const [, logValue] = mockMCP_LOGS.put.mock.calls[0]
       |                        ^
    263|   const logEntry = JSON.parse(logValue)
    264| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[10/10]â¯


 Test Files  2 failed | 7 passed (9)
      Tests  10 failed | 71 passed (81)
   Start at  07:03:56
   Duration  4.79s (transform 619ms, setup 0ms, collect 4.15s, tests 4.50s, environment 0ms, prepare 2.73s)

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  test/index.spec.ts x1 

 â¯ test/integration/logging-ratelimit.test.ts (7 tests | 7 failed) 109ms
   Ã— Logging and Rate Limiting Integration > should log successful MCP requests 19ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should log parse errors 4ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors 3ms
     â†’ expected 406 to be 429 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should skip rate limiting for initialize method 20ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully 4ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle empty request body 5ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should measure request latency accurately 6ms
     â†’ undefined is not iterable (cannot read property Symbol(Symbol.iterator))
[vpw:debug] Reusing runtime for vitest.config.mts...
stdout | test/index.spec.ts > Discogs MCP Server > should handle initialize request
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/index.spec.ts > Discogs MCP Server > should handle parse errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/index.spec.ts > Discogs MCP Server > should handle empty body
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

 â¯ test/index.spec.ts (6 tests | 3 failed) 246ms
   Ã— Discogs MCP Server > should handle initialize request 9ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return server info for GET requests to main endpoint
   Ã— Discogs MCP Server > should handle parse errors 11ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Discogs MCP Server > should handle empty body 28ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return 404 for unknown paths
   âœ“ Discogs MCP Server > should return 404 for unknown paths

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 3 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle initialize request
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:34:27
     32|   await waitOnExecutionContext(ctx)
     33| 
     34|   expect(response.status).toBe(200)
       |                           ^
     35|   expect(response.headers.get('content-type')).toBe('application/json')
     36| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/3]â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle parse errors
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:89:27
     87|   await waitOnExecutionContext(ctx)
     88| 
     89|   expect(response.status).toBe(200) // JSON-RPC errors still return 200
       |                           ^
     90|   const result = await response.json()
     91|   expect(result).toMatchObject({

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/3]â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle empty body
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:115:27
    113|   await waitOnExecutionContext(ctx)
    114| 
    115|   expect(response.status).toBe(200)
       |                           ^
    116|   const result = await response.json()
    117|   expect(result).toMatchObject({

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/3]â¯


 Test Files  2 failed (2)
      Tests  10 failed | 3 passed (13)
   Start at  07:04:42
   Duration  710ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  test/integration/logging-ratelimit.test.ts x1 

 â¯ test/index.spec.ts (6 tests | 3 failed) 246ms
   Ã— Discogs MCP Server > should handle initialize request 9ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return server info for GET requests to main endpoint
   Ã— Discogs MCP Server > should handle parse errors 11ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Discogs MCP Server > should handle empty body 28ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return 404 for unknown paths
   âœ“ Discogs MCP Server > should return 404 for unknown paths
[vpw:debug] Reusing runtime for vitest.config.mts...
stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log successful MCP requests
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log parse errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should skip rate limiting for initialize method
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle empty request body
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should measure request latency accurately
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

 â¯ test/integration/logging-ratelimit.test.ts (7 tests | 7 failed) 325ms
   Ã— Logging and Rate Limiting Integration > should log successful MCP requests 17ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should log parse errors 25ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors 5ms
     â†’ expected 406 to be 429 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should skip rate limiting for initialize method 14ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully 11ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle empty request body 5ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should measure request latency accurately 12ms
     â†’ undefined is not iterable (cannot read property Symbol(Symbol.iterator))

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 7 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log successful MCP requests
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:60:27
     58|   const response = await worker.fetch(request, mockEnv, {} as any)
     59| 
     60|   expect(response.status).toBe(200)
       |                           ^
     61| 
     62|   // Verify logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log parse errors
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:89:27
     87|   const response = await worker.fetch(request, mockEnv, {} as any)
     88| 
     89|   expect(response.status).toBe(200)
       |                           ^
     90| 
     91|   // Verify error logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors
AssertionError: expected 406 to be 429 // Object.is equality

- Expected
+ Received

- 429
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:125:27
    123|   const response = await worker.fetch(request, mockEnv, {} as any)
    124| 
    125|   expect(response.status).toBe(429)
       |                           ^
    126|   expect(response.headers.get('Retry-After')).toBeDefined()
    127| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should skip rate limiting for initialize method
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:167:27
    165| 
    166|   // Should succeed despite rate limit
    167|   expect(response.status).toBe(200)
       |                           ^
    168| 
    169|   // Rate limiting should not have been checked for initialize

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:207:27
    205| 
    206|   // Should still work without KV namespaces
    207|   expect(response.status).toBe(200)
       |                           ^
    208| 
    209|   // No KV operations should have been attempted

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle empty request body
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:223:27
    221|   const response = await worker.fetch(request, mockEnv, {} as any)
    222| 
    223|   expect(response.status).toBe(200)
       |                           ^
    224| 
    225|   // Verify error logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should measure request latency accurately
TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
 â¯ test/integration/logging-ratelimit.test.ts:262:24
    260|   const endTime = Date.now()
    261| 
    262|   const [, logValue] = mockMCP_LOGS.put.mock.calls[0]
       |                        ^
    263|   const logEntry = JSON.parse(logValue)
    264| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/7]â¯


 Test Files  2 failed (2)
      Tests  10 failed | 3 passed (13)
   Start at  07:04:44
   Duration  712ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
Test removed... [ test/index.spec.ts ]

Test removed... [ test/integration/logging-ratelimit.test.ts ]

