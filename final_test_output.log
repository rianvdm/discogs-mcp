
> discogs-mcp@0.0.0 test
> vitest


 DEV  v3.0.9 /Users/rian/Documents/GitHub/discogs-mcp

[vpw:info] Starting isolated runtimes for vitest.config.mts...
stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should successfully get a request token
Getting OAuth header for request token...

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should successfully get a request token
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Foauth%2Frequest_token&oauth_callback%3Dhttp%253A%252F%252Flocalhost%253A3000%252Fcallback%26oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3Dw5LmjAvX8kcphF3lNmkT9caQmnOLwRJj%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810866%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&
OAuth signature: olaSxj5gI3a3Ba08TVmteSGgeII=

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should successfully get a request token
Authorization header: OAuth oauth_consumer_key="test-consumer-key", oauth_nonce="w5LmjAvX8kcphF3lNmkT9caQmnOLwRJj", oauth_signature_method="HMAC-SHA1", oauth_timestamp="1765810866", oauth_version="1.0", oauth_callback="http%3A%2F%2Flocalhost%3A3000%2Fcallback", oauth_signature="olaSxj5gI3a3Ba08TVmteSGgeII%3D"
Making request to: https://api.discogs.com/oauth/request_token

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should successfully get a request token
Discogs response: oauth_token=test-token&oauth_token_secret=test-secret&oauth_callback_confirmed=true

stdout | test/utils/retry.test.ts > Retry Utility > withRetry > should retry on failure and eventually succeed
Retry attempt 1/3 after 108.6699170137778ms delay

stdout | test/utils/retry.test.ts > Retry Utility > withRetry > should retry on failure and eventually succeed
Retry attempt 2/3 after 202.34499570749395ms delay

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle API errors
Getting OAuth header for request token...

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle API errors
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Foauth%2Frequest_token&oauth_callback%3Dhttp%253A%252F%252Flocalhost%253A3000%252Fcallback%26oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3DBKQMFptJZuTX7S4rnslVrXOC8W79k0K5%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810866%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&
OAuth signature: 687nVNYFDh3l+fT3GaxU4dUCeWQ=

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle API errors
Authorization header: OAuth oauth_consumer_key="test-consumer-key", oauth_nonce="BKQMFptJZuTX7S4rnslVrXOC8W79k0K5", oauth_signature_method="HMAC-SHA1", oauth_timestamp="1765810866", oauth_version="1.0", oauth_callback="http%3A%2F%2Flocalhost%3A3000%2Fcallback", oauth_signature="687nVNYFDh3l%2BfT3GaxU4dUCeWQ%3D"
Making request to: https://api.discogs.com/oauth/request_token

stderr | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle API errors
Discogs API error: ResponseError: HTTP 401: Unauthorized
    at withRetry (/Users/rian/Documents/GitHub/discogs-mcp/src/utils/retry.ts:178:11)
    at withRetry (/Users/rian/Documents/GitHub/discogs-mcp/src/utils/retry.ts:108:17)
    at fetchWithRetry (/Users/rian/Documents/GitHub/discogs-mcp/src/utils/retry.ts:171:17)
    at DiscogsAuth.getRequestToken (/Users/rian/Documents/GitHub/discogs-mcp/src/auth/discogs.ts:179:21)
    at /Users/rian/Documents/GitHub/discogs-mcp/test/auth/discogs.spec.ts:61:4
    at Users/rian/Documents/GitHub/discogs-mcp/node_modules/@vitest/runner/dist/index.js:573:22 {
  response: {
    ok: false,
    status: 401,
    statusText: 'Unauthorized',
    text: [Function: text]
  }
}

stdout | test/utils/retry.test.ts > Retry Utility > withRetry > should fail after max retries
Retry attempt 1/2 after 101.9619379475176ms delay

stdout | test/utils/retry.test.ts > Retry Utility > withRetry > should fail after max retries
Retry attempt 2/2 after 204.08666744310742ms delay

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle malformed responses
Getting OAuth header for request token...

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should return all items when no query is provided
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fper_page%3D50&oauth_consumer_key%3Dtest-key%26oauth_nonce%3Dx4e0jPYC0KO3Vj5xN1pl15IeUz5b8xI0%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810866%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: di/ZFNGe1ixqNo3YXCQeM45p0Zw=

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle malformed responses
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Foauth%2Frequest_token&oauth_callback%3Dhttp%253A%252F%252Flocalhost%253A3000%252Fcallback%26oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3DIsH9btbI7gfHzMujBx1pLMDIJYPgk0Ol%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810866%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&
OAuth signature: eEixss6HiTLkvo4pw9Ydny2VVKI=

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle malformed responses
Authorization header: OAuth oauth_consumer_key="test-consumer-key", oauth_nonce="IsH9btbI7gfHzMujBx1pLMDIJYPgk0Ol", oauth_signature_method="HMAC-SHA1", oauth_timestamp="1765810866", oauth_version="1.0", oauth_callback="http%3A%2F%2Flocalhost%3A3000%2Fcallback", oauth_signature="eEixss6HiTLkvo4pw9Ydny2VVKI%3D"
Making request to: https://api.discogs.com/oauth/request_token

stderr | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle malformed responses
Discogs API error: Error: Invalid response from Discogs: missing oauth_token or oauth_token_secret
    at DiscogsAuth.getRequestToken (/Users/rian/Documents/GitHub/discogs-mcp/src/auth/discogs.ts:201:11)
    at /Users/rian/Documents/GitHub/discogs-mcp/test/auth/discogs.spec.ts:74:4
    at Users/rian/Documents/GitHub/discogs-mcp/node_modules/@vitest/runner/dist/index.js:573:22

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getRequestToken > should handle malformed responses
Discogs response: invalid_response

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should filter by artist name when query is provided
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3Dy1EEcRTQWtKB1Wboos1dCZE9SV5FivM8%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810866%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: H8hEARRAStVn2iDy+e3U3/sttTs=

stdout | test/utils/retry.test.ts > Retry Utility > fetchWithRetry > should retry on 429 status
Retry attempt 1/3 after 2048.394324760204ms delay

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getAccessToken > should successfully exchange for access token
OAuth signature base string: POST&https%3A%2F%2Fapi.discogs.com%2Foauth%2Faccess_token&oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3Dh6UwTLV4n3nYEfgsriEuCdDsctdy0rJZ%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810866%26oauth_token%3Drequest-token%26oauth_verifier%3Dverifier%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&request-secret
OAuth signature: 6Z5XjOE4Ehms3XtTUnY26lPe+xw=

stdout | test/utils/retry.test.ts > Retry Utility > fetchWithRetry > should parse Retry-After header in seconds
Retry attempt 1/3 after 5363.363488017877ms delay

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should filter by album title when query is provided
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DyD5oIUZI3rrUoL2oIIPMYTCIDVUg4q2I%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810866%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: QjsvWqnFqe/MK00Co/4v4NFh0Lk=

 âœ“ test/utils/kvLogger.test.ts (6 tests) 434ms
stdout | test/auth/discogs.spec.ts > DiscogsAuth > getAccessToken > should handle access token errors
OAuth signature base string: POST&https%3A%2F%2Fapi.discogs.com%2Foauth%2Faccess_token&oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3D1ybRVepBn1A9fvumftW69Adh84fQ1WUO%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810866%26oauth_token%3Drequest-token%26oauth_verifier%3Dinvalid-verifier%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&request-secret
OAuth signature: zJfGrTIMh7O446tj/VfjlMBLUt4=

stdout | test/utils/retry.test.ts > Retry Utility > fetchWithRetry > should parse Retry-After header as HTTP date
Retry attempt 1/3 after 2547.306961752792ms delay

stderr | test/auth/discogs.spec.ts > DiscogsAuth > getAccessToken > should handle access token errors
Discogs API error: ResponseError: HTTP 401: Unauthorized
    at withRetry (/Users/rian/Documents/GitHub/discogs-mcp/src/utils/retry.ts:178:11)
    at withRetry (/Users/rian/Documents/GitHub/discogs-mcp/src/utils/retry.ts:108:17)
    at fetchWithRetry (/Users/rian/Documents/GitHub/discogs-mcp/src/utils/retry.ts:171:17)
    at DiscogsAuth.getAccessToken (/Users/rian/Documents/GitHub/discogs-mcp/src/auth/discogs.ts:244:21)
    at /Users/rian/Documents/GitHub/discogs-mcp/test/auth/discogs.spec.ts:127:4
    at Users/rian/Documents/GitHub/discogs-mcp/node_modules/@vitest/runner/dist/index.js:573:22 {
  response: {
    ok: false,
    status: 401,
    statusText: 'Unauthorized',
    text: [Function: text]
  }
}

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getAccessToken > should handle malformed access token responses
OAuth signature base string: POST&https%3A%2F%2Fapi.discogs.com%2Foauth%2Faccess_token&oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3Dp0rXk5cGBpjPBbZ20z1LBbF5MjTTRoIe%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810866%26oauth_token%3Drequest-token%26oauth_verifier%3Dverifier%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&request-secret
OAuth signature: imJIZrp8XN56ro/10sRFUiuhSvE=

stderr | test/auth/discogs.spec.ts > DiscogsAuth > getAccessToken > should handle malformed access token responses
Discogs API error: Error: Invalid response from Discogs: missing oauth_token or oauth_token_secret
    at DiscogsAuth.getAccessToken (/Users/rian/Documents/GitHub/discogs-mcp/src/auth/discogs.ts:265:11)
    at /Users/rian/Documents/GitHub/discogs-mcp/test/auth/discogs.spec.ts:140:4
    at Users/rian/Documents/GitHub/discogs-mcp/node_modules/@vitest/runner/dist/index.js:573:22

stdout | test/utils/retry.test.ts > Retry Utility > fetchWithRetry > should retry on 5xx errors
Retry attempt 1/3 after 107.36945254025136ms delay

stdout | test/auth/discogs.spec.ts > DiscogsAuth > getAuthHeaders > should generate correct auth headers for API requests
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftest&oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3DdWPArohWm899htNLp3SSLvcWtSzr4pJ0%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810866%26oauth_token%3Daccess-token%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&access-secret
OAuth signature: PLRTfiSMxFQC5KOUjyexJb1px14=

 âœ“ test/utils/moodMapping.test.ts (10 tests) 492ms
 âœ“ test/utils/retry.test.ts (9 tests) 490ms
stdout | test/auth/discogs.spec.ts > DiscogsAuth > OAuth signature generation > should generate consistent signatures for the same parameters
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Ftest&oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3Dffffffffffffffffffffffffffffffff%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1672531200%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&test-secret
OAuth signature: g06ttDnmU3albDFhbKWiPttm5uk=

stdout | test/auth/discogs.spec.ts > DiscogsAuth > OAuth signature generation > should generate consistent signatures for the same parameters
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Ftest&oauth_consumer_key%3Dtest-consumer-key%26oauth_nonce%3Dffffffffffffffffffffffffffffffff%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1672531200%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-consumer-secret&test-secret
OAuth signature: g06ttDnmU3albDFhbKWiPttm5uk=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should filter by genre when query is provided
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3Dx5W75ZLw6jxxkHLjhgSqZwXnTsPoSSq0%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810866%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: /pOEq2NPMJkc3Fd/Csm8iEBfsn0=

 âœ“ test/auth/discogs.spec.ts (9 tests) 527ms
 âœ“ test/utils/rateLimit.test.ts (15 tests) 637ms
stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should return empty results when no matches found
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DwgwLlBlyJflqKFHtazajUeFnakLzAmGW%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810866%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: ezykHjrQHIcQHegUjIaA/yg7jlY=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should handle case-insensitive search
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DGqcQ1NkVByNbCXcOeoh3Tm54JwJKGYRc%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810867%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: iXr7dk6pK2gWjEPI+QSRtgvodec=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should find releases with multi-word queries like "Miles Davis Kind of Blue"
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3D058dbjYkJjbFIR6YqPIHj4YMZFJlqXBN%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810867%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: 5K+awR3IN9uZe5gdyE0lw7faTPs=

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/index.spec.ts > Discogs MCP Server > should handle initialize request
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log successful MCP requests
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
Response status: 200 Text length: 270 Text: event: message
data: {"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{"listChanged":true},"resources":{"listChanged":true},"completions":{},"prompts":{"listChanged":true}},"serverInf

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log parse errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
Response status: 200 Text length: 270 Text: event: message
data: {"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{"listChanged":true},"resources":{"listChanged":true},"completions":{},"prompts":{"listChanged":true}},"serverInf

stdout | test/index.spec.ts > Discogs MCP Server > should handle parse errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/index.spec.ts > Discogs MCP Server > should handle empty body
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should skip rate limiting for initialize method
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
Session ID extraction: { providedSessionId: 'mcp-efa543eedde602b1b37f96fe50283eb1' }
Looking up KV key: session:mcp-efa543eedde602b1b37f96fe50283eb1

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
No session found for key: session:mcp-efa543eedde602b1b37f96fe50283eb1

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
Response status: 200 Text length: 137 Text: event: message
data: {"jsonrpc":"2.0","id":2,"error":{"code":-32603,"message":"Authentication required to access collection resource"}}



stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 270 Text: event: message
data: {"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{"listChanged":true},"resources":{"listChanged":true},"completions":{},"prompts":{"listChanged":true}},"serverInf

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 224 Text: event: message
data: {"result":{"resources":[{"uri":"discogs://collection","name":"collection","mimeType":"application/json","description":"Complete Discogs collection for the authenticated user"}]},"

 â¯ test/index.spec.ts (6 tests | 3 failed) 58ms
   Ã— Discogs MCP Server > should handle initialize request 13ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return server info for GET requests to main endpoint
   Ã— Discogs MCP Server > should handle parse errors 4ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Discogs MCP Server > should handle empty body 4ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return 404 for unknown paths
   âœ“ Discogs MCP Server > should return 404 for unknown paths
stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle empty request body
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should handle decade queries like "1960s" matching years in that decade
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DlzRHwFxlfwhqR9t6dyk1mZYp8dWzBAjK%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810867%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: k4Eav8YxQrBagOYVrxjNTM59xjI=

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should measure request latency accurately
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

 â¯ test/integration/mcp-client.test.ts (3 tests | 2 failed) 76ms
   âœ“ MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
   Ã— MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources 16ms
     â†’ expected { jsonrpc: '2.0', id: 2, â€¦(1) } to match object { jsonrpc: '2.0', â€¦(1) }
(2 matching properties omitted from actual)
   Ã— MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features 9ms
     â†’ expected [ { â€¦(4) } ] to have a length of 3 but got 1
 â¯ test/integration/logging-ratelimit.test.ts (7 tests | 7 failed) 83ms
   Ã— Logging and Rate Limiting Integration > should log successful MCP requests 16ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should log parse errors 6ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors 3ms
     â†’ expected 406 to be 429 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should skip rate limiting for initialize method 3ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully 4ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle empty request body 4ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should measure request latency accurately 4ms
     â†’ undefined is not iterable (cannot read property Symbol(Symbol.iterator))
stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should handle multiple decades with OR logic (1960s OR 1970s)
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DiuEBiTLhrkhR86AOmlXnir2fR67TR9TV%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810867%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: wZs5nZA3bmog/OKqP2LjqpKDtNA=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should handle complex style and decade queries like "post-bop 1960s 1970s vinyl"
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3D7fKISp7uZmtBHuSK2ojBbQ5f4Ct9HCD7%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810867%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: v4uPwtoRhTC6GPITfv/ymf3JxFg=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should find release by specific ID 654321
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DsdU2lvYjkkVruvNQvPoBGJtKW4uJVmJ1%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810867%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: lwe1gt9fqu3ifdFq4x4ZzF+C1KA=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should handle temporal queries like "rock vinyl recent"
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DbTg38VodMpfFiH9vU2nx0oX4eMtBWSVn%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810867%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: ZqNCwyYR7Y+3NdrRVKvTHPtKj9E=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should use OR logic for multi-word genre searches like "ambient drone progressive"
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DUNSNzQAkjO5QpmzvDdIBclk0B9UmkV7y%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810868%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: g4CPoTUf2aJ+WPZIg96NO8Fh5hA=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should prioritize releases with more matching terms using relevance scoring
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3D2DqpPJly52nztCizyaXpW2aKwjOKBAcW%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810868%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: Jk1qXk6oiD1SEOdm56UX9ZNGJwE=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should prioritize mood-relevant releases for contextual queries like "cooking dinner mellow upbeat background"
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DoWg51kMghATr7qZDQyhTCDz7l611PUGy%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810868%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: NcD/MAyXjmsKillOu5JS3T2n1lA=

stdout | test/clients/discogs.test.ts > Discogs Client > searchCollection > should not trigger mood detection for specific album searches like "Dark Side of the Moon"
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DlLoD3jrJdFr7XU9m0REQVen3DFrnKp3Q%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765810868%26oauth_token%3Dtest-token%26oauth_version%3D1.0
OAuth signing key: test-secret-key&test-secret
OAuth signature: NGW1HppIqnpf2SYNopzl2heW44g=

 âœ“ test/clients/discogs.test.ts (16 tests) 2284ms

â¯â¯â¯â¯â¯â¯ Failed Tests 12 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle initialize request
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:33:27
     31|   await waitOnExecutionContext(ctx)
     32| 
     33|   expect(response.status).toBe(200)
       |                           ^
     34|   expect(response.headers.get('content-type')).toBe('application/json')
     35| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/12]â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle parse errors
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:84:27
     82|   await waitOnExecutionContext(ctx)
     83| 
     84|   expect(response.status).toBe(200) // JSON-RPC errors still return 200
       |                           ^
     85|   const result = await response.json()
     86|   expect(result).toMatchObject({

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/12]â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle empty body
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:106:27
    104|   await waitOnExecutionContext(ctx)
    105| 
    106|   expect(response.status).toBe(200)
       |                           ^
    107|   const result = await response.json()
    108|   expect(result).toMatchObject({

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/12]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log successful MCP requests
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:60:27
     58|   const response = await worker.fetch(request, mockEnv, {} as any)
     59| 
     60|   expect(response.status).toBe(200)
       |                           ^
     61| 
     62|   // Verify logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/12]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log parse errors
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:89:27
     87|   const response = await worker.fetch(request, mockEnv, {} as any)
     88| 
     89|   expect(response.status).toBe(200)
       |                           ^
     90| 
     91|   // Verify error logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/12]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors
AssertionError: expected 406 to be 429 // Object.is equality

- Expected
+ Received

- 429
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:125:27
    123|   const response = await worker.fetch(request, mockEnv, {} as any)
    124| 
    125|   expect(response.status).toBe(429)
       |                           ^
    126|   expect(response.headers.get('Retry-After')).toBeDefined()
    127| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/12]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should skip rate limiting for initialize method
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:167:27
    165| 
    166|   // Should succeed despite rate limit
    167|   expect(response.status).toBe(200)
       |                           ^
    168| 
    169|   // Rate limiting should not have been checked for initialize

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/12]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:207:27
    205| 
    206|   // Should still work without KV namespaces
    207|   expect(response.status).toBe(200)
       |                           ^
    208| 
    209|   // No KV operations should have been attempted

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[8/12]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle empty request body
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:223:27
    221|   const response = await worker.fetch(request, mockEnv, {} as any)
    222| 
    223|   expect(response.status).toBe(200)
       |                           ^
    224| 
    225|   // Verify error logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[9/12]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should measure request latency accurately
TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
 â¯ test/integration/logging-ratelimit.test.ts:262:24
    260|   const endTime = Date.now()
    261| 
    262|   const [, logValue] = mockMCP_LOGS.put.mock.calls[0]
       |                        ^
    263|   const logEntry = JSON.parse(logValue)
    264| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[10/12]â¯

 FAIL  test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
AssertionError: expected { jsonrpc: '2.0', id: 2, â€¦(1) } to match object { jsonrpc: '2.0', â€¦(1) }
(2 matching properties omitted from actual)

- Expected
+ Received

  {
    "error": {
-     "code": -32602,
+     "code": -32603,
    },
    "jsonrpc": "2.0",
  }

 â¯ Proxy.methodWrapper Users/rian/Documents/GitHub/discogs-mcp/node_modules/.vite/vitest/deps_ssr/chai.js:1537:25
 â¯ test/integration/mcp-client.test.ts:347:19
    345|    const result = await client.readResource('discogs://collection')
    346| 
    347|    expect(result).toMatchObject({
       |                   ^
    348|     jsonrpc: '2.0',
    349|     error: {

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[11/12]â¯

 FAIL  test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
AssertionError: expected [ { â€¦(4) } ] to have a length of 3 but got 1

- Expected
+ Received

- 3
+ 1

 â¯ Proxy.methodWrapper Users/rian/Documents/GitHub/discogs-mcp/node_modules/.vite/vitest/deps_ssr/chai.js:1537:25
 â¯ test/integration/mcp-client.test.ts:362:43
    360|    // Test resources
    361|    const resourcesList = await client.listResources()
    362|    expect(resourcesList.result.resources).toHaveLength(3)
       |                                           ^
    363| 
    364|    const collectionResource = await client.readResource('discogs://colâ€¦

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[12/12]â¯


 Test Files  3 failed | 6 passed (9)
      Tests  12 failed | 69 passed (81)
   Start at  07:01:04
   Duration  4.64s (transform 766ms, setup 0ms, collect 4.76s, tests 5.08s, environment 4ms, prepare 3.05s)

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  test/index.spec.ts x1 

 â¯ test/integration/mcp-client.test.ts (3 tests | 2 failed) 76ms
   âœ“ MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
   Ã— MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources 16ms
     â†’ expected { jsonrpc: '2.0', id: 2, â€¦(1) } to match object { jsonrpc: '2.0', â€¦(1) }
(2 matching properties omitted from actual)
   Ã— MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features 9ms
     â†’ expected [ { â€¦(4) } ] to have a length of 3 but got 1
 â¯ test/integration/logging-ratelimit.test.ts (7 tests | 7 failed) 83ms
   Ã— Logging and Rate Limiting Integration > should log successful MCP requests 16ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should log parse errors 6ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors 3ms
     â†’ expected 406 to be 429 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should skip rate limiting for initialize method 3ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully 4ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle empty request body 4ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should measure request latency accurately 4ms
     â†’ undefined is not iterable (cannot read property Symbol(Symbol.iterator))
[vpw:debug] Reusing runtime for vitest.config.mts...
stdout | test/index.spec.ts > Discogs MCP Server > should handle initialize request
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/index.spec.ts > Discogs MCP Server > should handle parse errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/index.spec.ts > Discogs MCP Server > should handle empty body
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

 â¯ test/index.spec.ts (6 tests | 3 failed) 392ms
   Ã— Discogs MCP Server > should handle initialize request 7ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return server info for GET requests to main endpoint
   Ã— Discogs MCP Server > should handle parse errors 20ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Discogs MCP Server > should handle empty body 14ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return 404 for unknown paths
   âœ“ Discogs MCP Server > should return 404 for unknown paths

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 3 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle initialize request
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:34:27
     32|   await waitOnExecutionContext(ctx)
     33| 
     34|   expect(response.status).toBe(200)
       |                           ^
     35|   expect(response.headers.get('content-type')).toBe('application/json')
     36| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/3]â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle parse errors
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:89:11
     87|   await waitOnExecutionContext(ctx)
     88| 
     89|   expect(response.status).toBe(200) // JSON-RPC errors still return 200
       |           ^
     90|   const result = await response.json()
     91|   expect(result).toMatchObject({

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/3]â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle empty body
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:115:4
    113|   await waitOnExecutionContext(ctx)
    114| 
    115|   expect(response.status).toBe(200)
       |    ^
    116|   const result = await response.json()
    117|   expect(result).toMatchObject({

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/3]â¯


 Test Files  3 failed (3)
      Tests  12 failed | 4 passed (16)
   Start at  07:02:24
   Duration  1.08s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  test/integration/logging-ratelimit.test.ts x1 

 â¯ test/integration/mcp-client.test.ts (3 tests | 2 failed) 76ms
   âœ“ MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
   Ã— MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources 16ms
     â†’ expected { jsonrpc: '2.0', id: 2, â€¦(1) } to match object { jsonrpc: '2.0', â€¦(1) }
(2 matching properties omitted from actual)
   Ã— MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features 9ms
     â†’ expected [ { â€¦(4) } ] to have a length of 3 but got 1
 â¯ test/index.spec.ts (6 tests | 3 failed) 392ms
   Ã— Discogs MCP Server > should handle initialize request 7ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return server info for GET requests to main endpoint
   Ã— Discogs MCP Server > should handle parse errors 20ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Discogs MCP Server > should handle empty body 14ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return 404 for unknown paths
   âœ“ Discogs MCP Server > should return 404 for unknown paths
[vpw:debug] Reusing runtime for vitest.config.mts...
stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log successful MCP requests
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log parse errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should skip rate limiting for initialize method
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle empty request body
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should measure request latency accurately
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

 â¯ test/integration/logging-ratelimit.test.ts (7 tests | 7 failed) 215ms
   Ã— Logging and Rate Limiting Integration > should log successful MCP requests 11ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should log parse errors 12ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors 9ms
     â†’ expected 406 to be 429 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should skip rate limiting for initialize method 7ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully 5ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle empty request body 6ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should measure request latency accurately 3ms
     â†’ undefined is not iterable (cannot read property Symbol(Symbol.iterator))

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 7 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log successful MCP requests
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:60:27
     58|   const response = await worker.fetch(request, mockEnv, {} as any)
     59| 
     60|   expect(response.status).toBe(200)
       |                           ^
     61| 
     62|   // Verify logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log parse errors
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:89:27
     87|   const response = await worker.fetch(request, mockEnv, {} as any)
     88| 
     89|   expect(response.status).toBe(200)
       |                           ^
     90| 
     91|   // Verify error logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors
AssertionError: expected 406 to be 429 // Object.is equality

- Expected
+ Received

- 429
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:125:27
    123|   const response = await worker.fetch(request, mockEnv, {} as any)
    124| 
    125|   expect(response.status).toBe(429)
       |                           ^
    126|   expect(response.headers.get('Retry-After')).toBeDefined()
    127| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should skip rate limiting for initialize method
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:167:27
    165| 
    166|   // Should succeed despite rate limit
    167|   expect(response.status).toBe(200)
       |                           ^
    168| 
    169|   // Rate limiting should not have been checked for initialize

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:207:27
    205| 
    206|   // Should still work without KV namespaces
    207|   expect(response.status).toBe(200)
       |                           ^
    208| 
    209|   // No KV operations should have been attempted

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle empty request body
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:223:27
    221|   const response = await worker.fetch(request, mockEnv, {} as any)
    222| 
    223|   expect(response.status).toBe(200)
       |                           ^
    224| 
    225|   // Verify error logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should measure request latency accurately
TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
 â¯ test/integration/logging-ratelimit.test.ts:262:24
    260|   const endTime = Date.now()
    261| 
    262|   const [, logValue] = mockMCP_LOGS.put.mock.calls[0]
       |                        ^
    263|   const logEntry = JSON.parse(logValue)
    264| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/7]â¯


 Test Files  3 failed (3)
      Tests  12 failed | 4 passed (16)
   Start at  07:02:28
   Duration  445ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  test/integration/mcp-client.test.ts x1 

 â¯ test/integration/logging-ratelimit.test.ts (7 tests | 7 failed) 215ms
   Ã— Logging and Rate Limiting Integration > should log successful MCP requests 11ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should log parse errors 12ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors 9ms
     â†’ expected 406 to be 429 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should skip rate limiting for initialize method 7ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully 5ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle empty request body 6ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should measure request latency accurately 3ms
     â†’ undefined is not iterable (cannot read property Symbol(Symbol.iterator))
 â¯ test/index.spec.ts (6 tests | 3 failed) 392ms
   Ã— Discogs MCP Server > should handle initialize request 7ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return server info for GET requests to main endpoint
   Ã— Discogs MCP Server > should handle parse errors 20ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Discogs MCP Server > should handle empty body 14ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return 404 for unknown paths
   âœ“ Discogs MCP Server > should return 404 for unknown paths
[vpw:debug] Reusing runtime for vitest.config.mts...
stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
Response status: 200 Text length: 270 Text: event: message
data: {"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{"listChanged":true},"resources":{"listChanged":true},"completions":{},"prompts":{"listChanged":true}},"serverInf

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
Response status: 200 Text length: 270 Text: event: message
data: {"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{"listChanged":true},"resources":{"listChanged":true},"completions":{},"prompts":{"listChanged":true}},"serverInf

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
Session ID extraction: { providedSessionId: 'mcp-efa543eedde602b1b37f96fe50283eb1' }
Looking up KV key: session:mcp-efa543eedde602b1b37f96fe50283eb1

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
No session found for key: session:mcp-efa543eedde602b1b37f96fe50283eb1

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
Response status: 200 Text length: 137 Text: event: message
data: {"jsonrpc":"2.0","id":2,"error":{"code":-32603,"message":"Authentication required to access collection resource"}}



stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 270 Text: event: message
data: {"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{"listChanged":true},"resources":{"listChanged":true},"completions":{},"prompts":{"listChanged":true}},"serverInf

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 3681 Text: event: message
data: {"result":{"tools":[{"name":"ping","description":"Test connectivity to the Discogs MCP server","inputSchema":{"$schema":"http://json-schema.org/draft-07/schema#","type":"object","

 â¯ test/integration/mcp-client.test.ts (3 tests | 1 failed) 216ms
   âœ“ MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
   âœ“ MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
   Ã— MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features 49ms
     â†’ expected [ { name: 'ping', â€¦(3) }, â€¦(7) ] to have a length of 2 but got 8

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 1 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
AssertionError: expected [ { name: 'ping', â€¦(3) }, â€¦(7) ] to have a length of 2 but got 8

- Expected
+ Received

- 2
+ 8

 â¯ Proxy.methodWrapper Users/rian/Documents/GitHub/discogs-mcp/node_modules/.vite/vitest/deps_ssr/chai.js:1537:25
 â¯ test/integration/mcp-client.test.ts:361:53
    359|    // Test tools
    360|    const toolsList = await client.listTools()
    361|    expect(toolsList.result.tools).toHaveLength(2) // public + authentiâ€¦
       |                                                     ^
    362| 
    363|    // Test resources

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/1]â¯


 Test Files  3 failed (3)
      Tests  11 failed | 5 passed (16)
   Start at  07:03:32
   Duration  679ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  test/integration/mcp-client.test.ts x2 

 â¯ test/integration/logging-ratelimit.test.ts (7 tests | 7 failed) 215ms
   Ã— Logging and Rate Limiting Integration > should log successful MCP requests 11ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should log parse errors 12ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors 9ms
     â†’ expected 406 to be 429 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should skip rate limiting for initialize method 7ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully 5ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle empty request body 6ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should measure request latency accurately 3ms
     â†’ undefined is not iterable (cannot read property Symbol(Symbol.iterator))
 â¯ test/index.spec.ts (6 tests | 3 failed) 392ms
   Ã— Discogs MCP Server > should handle initialize request 7ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return server info for GET requests to main endpoint
   Ã— Discogs MCP Server > should handle parse errors 20ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Discogs MCP Server > should handle empty body 14ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return 404 for unknown paths
   âœ“ Discogs MCP Server > should return 404 for unknown paths
[vpw:debug] Reusing runtime for vitest.config.mts...
stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
Response status: 200 Text length: 270 Text: event: message
data: {"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{"listChanged":true},"resources":{"listChanged":true},"completions":{},"prompts":{"listChanged":true}},"serverInf

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should complete full initialization handshake
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
Response status: 200 Text length: 270 Text: event: message
data: {"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{"listChanged":true},"resources":{"listChanged":true},"completions":{},"prompts":{"listChanged":true}},"serverInf

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
Session ID extraction: { providedSessionId: 'mcp-efa543eedde602b1b37f96fe50283eb1' }
Looking up KV key: session:mcp-efa543eedde602b1b37f96fe50283eb1

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
No session found for key: session:mcp-efa543eedde602b1b37f96fe50283eb1

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should handle unauthenticated access to protected resources
Response status: 200 Text length: 137 Text: event: message
data: {"jsonrpc":"2.0","id":2,"error":{"code":-32603,"message":"Authentication required to access collection resource"}}



stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 270 Text: event: message
data: {"result":{"protocolVersion":"2024-11-05","capabilities":{"tools":{"listChanged":true},"resources":{"listChanged":true},"completions":{},"prompts":{"listChanged":true}},"serverInf

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 224 Text: event: message
data: {"result":{"resources":[{"uri":"discogs://collection","name":"collection","mimeType":"application/json","description":"Complete Discogs collection for the authenticated user"}]},"

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Session ID extraction: { providedSessionId: 'mcp-efa543eedde602b1b37f96fe50283eb1' }

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Fetching fresh data for userProfiles:test-access-token
Making OAuth request to /oauth/identity with token: test-acces...

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Foauth%2Fidentity&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DTDnXyWTaTYS1fm7Nu8UPOCPvqhO1mPtU%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811033%26oauth_token%3Dtest-access-token%26oauth_version%3D1.0
OAuth signing key: test-secret&test-access-secret
OAuth signature: FUgywX+IOQQM++HJbNUOFrbYchI=

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Fetching fresh data for collections:testuser:all:default:desc

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fper_page%3D100&oauth_consumer_key%3Dtest-key%26oauth_nonce%3D2CsOtdJHcq6WmduGBrPtLplwkVl2EugA%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811033%26oauth_token%3Dtest-access-token%26oauth_version%3D1.0
OAuth signing key: test-secret&test-access-secret
OAuth signature: kCYfD0vRQVbsJtd/tCa2U2/FPHw=

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 2115 Text: event: message
data: {"result":{"contents":[{"uri":"discogs://collection","mimeType":"application/json","text":"{\n  \"releases\": [\n    {\n      \"id\": 123456,\n      \"instance_id\": 123456,\n    

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 3681 Text: event: message
data: {"result":{"tools":[{"name":"ping","description":"Test connectivity to the Discogs MCP server","inputSchema":{"$schema":"http://json-schema.org/draft-07/schema#","type":"object","

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Session ID extraction: { providedSessionId: 'mcp-efa543eedde602b1b37f96fe50283eb1' }

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Fetching fresh data for userProfiles:test-access-token
Making OAuth request to /oauth/identity with token: test-acces...

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Foauth%2Fidentity&oauth_consumer_key%3Dtest-key%26oauth_nonce%3D9mkQg0U9F14OlcFDC8hqxp2i06P1Hdfx%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811033%26oauth_token%3Dtest-access-token%26oauth_version%3D1.0
OAuth signing key: test-secret&test-access-secret
OAuth signature: SVYVqg2WUxxzwmZBuKzc6x8vGTk=

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Fetching fresh data for searches:testuser:Beatles:1

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
OAuth signature base string: GET&https%3A%2F%2Fapi.discogs.com%2Fusers%2Ftestuser%2Fcollection%2Ffolders%2F0%2Freleases%3Fpage%3D1%26per_page%3D100%26sort%3Dadded%26sort_order%3Ddesc&oauth_consumer_key%3Dtest-key%26oauth_nonce%3DXMIyKDZGAuYZsVXZIoDSSiCxmLTb4ZtG%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1765811033%26oauth_token%3Dtest-access-token%26oauth_version%3D1.0
OAuth signing key: test-secret&test-access-secret
OAuth signature: dqo80MBuiYrg2mh/uF0tfS5MNF4=

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 372 Text: event: message
data: {"result":{"content":[{"type":"text","text":"Found 1 results for \"Beatles\" in your collection (showing 1 items):\nâ€¢ [ID: 123456] The Beatles - Abbey Road (1969)\n  Format: Vinyl

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/mcp-client.test.ts > MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features
Response status: 200 Text length: 421 Text: event: message
data: {"result":{"prompts":[{"name":"browse_collection","description":"Browse and explore your Discogs music collection","arguments":[]},{"name":"find_music","description":"Find specifi

 âœ“ test/integration/mcp-client.test.ts (3 tests) 525ms
   âœ“ MCP Client Integration Tests > Full MCP Protocol Flow > should allow authenticated access to all features 359ms

 Test Files  2 failed | 1 passed (3)
      Tests  10 failed | 6 passed (16)
   Start at  07:03:52
   Duration  1.08s

 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  test/index.spec.ts x2 

 â¯ test/integration/logging-ratelimit.test.ts (7 tests | 7 failed) 215ms
   Ã— Logging and Rate Limiting Integration > should log successful MCP requests 11ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should log parse errors 12ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors 9ms
     â†’ expected 406 to be 429 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should skip rate limiting for initialize method 7ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully 5ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle empty request body 6ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should measure request latency accurately 3ms
     â†’ undefined is not iterable (cannot read property Symbol(Symbol.iterator))
[vpw:debug] Reusing runtime for vitest.config.mts...
stdout | test/index.spec.ts > Discogs MCP Server > should handle initialize request
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/index.spec.ts > Discogs MCP Server > should handle parse errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/index.spec.ts > Discogs MCP Server > should handle empty body
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

 â¯ test/index.spec.ts (6 tests | 3 failed) 220ms
   Ã— Discogs MCP Server > should handle initialize request 64ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return server info for GET requests to main endpoint
   Ã— Discogs MCP Server > should handle parse errors 9ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Discogs MCP Server > should handle empty body 7ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return 404 for unknown paths
   âœ“ Discogs MCP Server > should return 404 for unknown paths

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 3 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle initialize request
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:34:27
     32|   await waitOnExecutionContext(ctx)
     33| 
     34|   expect(response.status).toBe(200)
       |                           ^
     35|   expect(response.headers.get('content-type')).toBe('application/json')
     36| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/3]â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle parse errors
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:89:11
     87|   await waitOnExecutionContext(ctx)
     88| 
     89|   expect(response.status).toBe(200) // JSON-RPC errors still return 200
       |           ^
     90|   const result = await response.json()
     91|   expect(result).toMatchObject({

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/3]â¯

 FAIL  test/index.spec.ts > Discogs MCP Server > should handle empty body
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/index.spec.ts:115:4
    113|   await waitOnExecutionContext(ctx)
    114| 
    115|   expect(response.status).toBe(200)
       |    ^
    116|   const result = await response.json()
    117|   expect(result).toMatchObject({

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/3]â¯


 Test Files  2 failed (2)
      Tests  10 failed | 3 passed (13)
   Start at  07:04:42
   Duration  596ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  test/integration/logging-ratelimit.test.ts x2 

 â¯ test/index.spec.ts (6 tests | 3 failed) 220ms
   Ã— Discogs MCP Server > should handle initialize request 64ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return server info for GET requests to main endpoint
   Ã— Discogs MCP Server > should handle parse errors 9ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Discogs MCP Server > should handle empty body 7ms
     â†’ expected 406 to be 200 // Object.is equality
   âœ“ Discogs MCP Server > should return 404 for unknown paths
   âœ“ Discogs MCP Server > should return 404 for unknown paths
[vpw:debug] Reusing runtime for vitest.config.mts...
stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log successful MCP requests
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log parse errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should skip rate limiting for initialize method
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle empty request body
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

stdout | test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should measure request latency accurately
[MCP] Session ID: mcp-efa543eedde602b1b37f96fe50283eb1 (source: deterministic)

 â¯ test/integration/logging-ratelimit.test.ts (7 tests | 7 failed) 335ms
   Ã— Logging and Rate Limiting Integration > should log successful MCP requests 10ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should log parse errors 7ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors 38ms
     â†’ expected 406 to be 429 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should skip rate limiting for initialize method 8ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully 12ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should handle empty request body 15ms
     â†’ expected 406 to be 200 // Object.is equality
   Ã— Logging and Rate Limiting Integration > should measure request latency accurately 13ms
     â†’ undefined is not iterable (cannot read property Symbol(Symbol.iterator))

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 7 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log successful MCP requests
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:60:27
     58|   const response = await worker.fetch(request, mockEnv, {} as any)
     59| 
     60|   expect(response.status).toBe(200)
       |                           ^
     61| 
     62|   // Verify logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should log parse errors
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:89:27
     87|   const response = await worker.fetch(request, mockEnv, {} as any)
     88| 
     89|   expect(response.status).toBe(200)
       |                           ^
     90| 
     91|   // Verify error logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should apply rate limiting and log rate limit errors
AssertionError: expected 406 to be 429 // Object.is equality

- Expected
+ Received

- 429
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:125:27
    123|   const response = await worker.fetch(request, mockEnv, {} as any)
    124| 
    125|   expect(response.status).toBe(429)
       |                           ^
    126|   expect(response.headers.get('Retry-After')).toBeDefined()
    127| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should skip rate limiting for initialize method
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:167:27
    165| 
    166|   // Should succeed despite rate limit
    167|   expect(response.status).toBe(200)
       |                           ^
    168| 
    169|   // Rate limiting should not have been checked for initialize

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle missing KV namespaces gracefully
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:207:27
    205| 
    206|   // Should still work without KV namespaces
    207|   expect(response.status).toBe(200)
       |                           ^
    208| 
    209|   // No KV operations should have been attempted

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should handle empty request body
AssertionError: expected 406 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 406

 â¯ test/integration/logging-ratelimit.test.ts:223:27
    221|   const response = await worker.fetch(request, mockEnv, {} as any)
    222| 
    223|   expect(response.status).toBe(200)
       |                           ^
    224| 
    225|   // Verify error logging was called

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/7]â¯

 FAIL  test/integration/logging-ratelimit.test.ts > Logging and Rate Limiting Integration > should measure request latency accurately
TypeError: undefined is not iterable (cannot read property Symbol(Symbol.iterator))
 â¯ test/integration/logging-ratelimit.test.ts:262:24
    260|   const endTime = Date.now()
    261| 
    262|   const [, logValue] = mockMCP_LOGS.put.mock.calls[0]
       |                        ^
    263|   const logEntry = JSON.parse(logValue)
    264| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/7]â¯


 Test Files  2 failed (2)
      Tests  10 failed | 3 passed (13)
   Start at  07:04:44
   Duration  787ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
Test removed... [ test/index.spec.ts ]

Test removed... [ test/integration/logging-ratelimit.test.ts ]

